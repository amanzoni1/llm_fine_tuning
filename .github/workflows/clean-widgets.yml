name: Strip ipywidgets state for GitHub rendering

on:
  push:
    paths:
      - "**/*.ipynb"
  workflow_dispatch: 

jobs:
  clean-widgets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Strip widgets metadata
        run: |
          python - <<'EOF'
          import json
          import pathlib
          changed = False
          for p in pathlib.Path(".").rglob("*.ipynb"):
              if p.stat().st_size == 0:
                  continue
              nb = json.load(open(p, encoding="utf-8"))
              for cell in nb.get("cells", []):
                  if cell.get("metadata", {}).get("widgets"):
                      del cell["metadata"]["widgets"]
                      changed = True
              if changed:
                  json.dump(nb, open(p, "w", encoding="utf-8"), indent=1, ensure_ascii=False)
                  print(f"Cleaned {p}")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --quiet && echo "No changes" && exit 0
          git commit -m "chore: strip ipywidgets metadata for GitHub rendering"
          git push
